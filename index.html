<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KW ANALYST V9.9 - Timezone Aware</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        /* 繼承 V9.3/9.8 的核心視覺風格，不變動排版 */
        :root { --primary: #4F46E5; --secondary: #64748b; --success: #10b981; --danger: #ef4444; --bg-body: #f3f4f6; --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); }
        body { background-color: var(--bg-body); font-family: 'Inter', 'Noto Sans TC', sans-serif; color: #1f2937; padding-bottom: 60px; }
        .main-header { text-align: center; padding: 40px 0; background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); margin-bottom: 30px; border-bottom: 1px solid #e5e7eb; }
        .app-title { font-weight: 900; font-size: 2.2rem; letter-spacing: -0.05em; background: linear-gradient(to right, #4F46E5, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .version-tag { background: #e0e7ff; color: #4338ca; font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: 700; vertical-align: middle; }
        .kw-card { background: white; border-radius: 16px; border: 1px solid #f1f5f9; box-shadow: var(--card-shadow); padding: 24px; margin-bottom: 24px; transition: transform 0.2s; }
        .kw-card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1); }
        .btn-action { border: none; border-radius: 12px; padding: 14px; font-weight: 700; width: 100%; transition: all 0.2s; color: white; margin-top: 10px; }
        .btn-live { background: linear-gradient(135deg, #4F46E5 0%, #7c3aed 100%); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
        .btn-bt { background: linear-gradient(135deg, #059669 0%, #10b981 100%); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        .btn-action:hover { filter: brightness(1.1); transform: scale(1.02); }
        .price-display { text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px dashed #cbd5e1; }
        .price-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
        .price-val { font-size: 2rem; font-weight: 800; color: #111827; line-height: 1; }
        .vol-val { font-size: 0.9rem; color: #6b7280; font-weight: 500; margin-top: 5px; }
        .trend-badge { display: inline-block; padding: 8px 16px; border-radius: 50px; font-weight: 700; font-size: 0.9rem; margin-bottom: 15px; }
        .trend-up { background: #dcfce7; color: #166534; }
        .trend-down { background: #fee2e2; color: #991b1b; }
        .btn-logic { background: white; border: 2px solid #e5e7eb; color: #374151; font-weight: 600; border-radius: 50px; padding: 10px 24px; transition: all 0.2s; }
        .btn-logic:hover { border-color: #4F46E5; color: #4F46E5; background: #eef2ff; }
        .history-table th { font-size: 0.75rem; text-transform: uppercase; color: #9ca3af; font-weight: 700; border: none; }
        .history-table td { font-size: 0.9rem; font-weight: 500; border-bottom: 1px solid #f3f4f6; vertical-align: middle; padding: 12px 8px; }
        .prob-bar-bg { background: #f3f4f6; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .prob-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #4F46E5, #ec4899); transition: width 1s ease; }
        
        /* Modal 優化：Point Form 樣式 */
        .modal-content { border-radius: 20px; border: none; }
        .modal-header { background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 20px 30px; }
        .modal-body { padding: 40px; background: #fff; }
        .step-block { margin-bottom: 40px; border-left: 3px solid #e2e8f0; padding-left: 25px; position: relative; }
        .step-icon { position: absolute; left: -44px; top: 0; width: 36px; height: 36px; background: #4F46E5; color: white; border-radius: 50%; text-align: center; line-height: 36px; font-weight: bold; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .point-list { list-style: none; padding: 0; margin-top: 15px; }
        .point-list li { margin-bottom: 12px; position: relative; padding-left: 20px; color: #4b5563; font-size: 0.95rem; line-height: 1.6; }
        .point-list li::before { content: '•'; color: #4F46E5; position: absolute; left: 0; top: 0; font-weight: bold; font-size: 1.2rem; }
        .viz-container { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-top: 15px; text-align: center; }
        .formula-display { font-family: 'Courier New', monospace; background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #818cf8; font-size: 0.9rem; }
        .flow-arrow-down { color: #cbd5e1; font-size: 1.2rem; margin: 10px 0; }
    </style>
</head>
<body>

<div class="main-header">
    <div class="container">
        <div class="app-title"><i class="fas fa-layer-group me-2"></i>KW ANALYST</div>
        <div class="text-secondary fw-bold mt-2" style="font-size: 0.9rem;">V9.9 TIMEZONE AWARE <span class="version-tag">STABLE</span></div>
    </div>
</div>

<div class="container" style="max-width: 800px;">
    <div class="kw-card">
        <div class="row g-4">
            <div class="col-md-7">
                <label class="small text-secondary fw-bold mb-2">TARGET SYMBOL (全球代號)</label>
                <div class="search-wrapper">
                    <i class="fas fa-search text-muted"></i>
                    <input type="text" id="symbol" class="form-control ms-2" value="TSLA" placeholder="0700, AAPL, NVDA, 2330...">
                    <span id="market-tag" class="badge bg-light text-dark ms-2">HK/US</span>
                </div>
            </div>
            <div class="col-md-5">
                <label class="small text-secondary fw-bold mb-2">ACTION</label>
                <button class="btn-action btn-live" onclick="runAnalysis(false)">
                    <i class="fas fa-bolt me-2"></i>開始分析 (Live)
                </button>
            </div>
            <div class="col-12"><hr class="text-muted opacity-25 my-1"></div>
            <div class="col-md-7">
                <label class="small text-secondary fw-bold mb-2">BACKTEST DATE</label>
                <div class="search-wrapper">
                    <i class="fas fa-calendar-alt text-muted"></i>
                    <input type="date" id="test-date" class="form-control ms-2">
                </div>
            </div>
            <div class="col-md-5">
                <label class="small text-secondary fw-bold mb-2">VALIDATION</label>
                <button class="btn-action btn-bt" onclick="runAnalysis(true)">
                    <i class="fas fa-flask me-2"></i>回測驗證 (Test)
                </button>
            </div>
        </div>
        <div id="loading" class="text-center mt-3 text-primary fw-bold" style="display:none;">
            <i class="fas fa-spinner fa-spin me-2"></i>數據運算中 (全球節點)...
        </div>
    </div>

    <div id="panel-live" style="display: none;">
        <div class="kw-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-bold m-0"><i class="fas fa-crosshairs text-primary me-2"></i>AI 預測模型 <span id="res-date" class="badge bg-secondary ms-2 small">--</span></h5>
                <div id="direction-badge" class="trend-badge trend-up">--</div>
            </div>
            <div class="price-display">
                <div class="row">
                    <div class="col-6 border-end">
                        <div class="price-label">Low Support</div>
                        <div class="price-val text-danger" id="pred-low">--</div>
                    </div>
                    <div class="col-6">
                        <div class="price-label">High Resistance</div>
                        <div class="price-val text-success" id="pred-high">--</div>
                    </div>
                </div>
                <div class="vol-val" id="pred-vol">--</div>
            </div>
            <div class="text-center mt-4">
                <button class="btn-logic" onclick="showLogicPopup()">
                    <i class="fas fa-brain me-2"></i> AI 演算邏輯深度解析
                </button>
            </div>
        </div>

        <div class="kw-card p-0 overflow-hidden"><div id="chart-live" style="height: 350px;"></div></div>

        <div class="kw-card">
            <h6 class="fw-bold mb-3 text-secondary">過去 5 日模型驗證 (基於 T-1 預測 T)</h6>
            <div class="table-responsive">
                <table class="table history-table mb-0">
                    <thead><tr><th>日期 (星期)</th><th>真實區間</th><th>AI 預測區間</th><th>準確度</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>

        <div class="kw-card">
            <h6 class="fw-bold mb-3 text-secondary">T+5 動能機率 (Momentum)</h6>
            <div id="probs-container"></div>
        </div>
    </div>

    <div id="panel-backtest" style="display: none;">
        <div class="kw-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold m-0">回測報告 <span id="bt-date-display" class="text-muted small">--</span></h5>
                <div id="bt-score" class="fw-900 fs-3 text-primary">--%</div>
            </div>
            <div class="row g-3 text-center">
                <div class="col-6"><div class="p-3 bg-light rounded"><small class="text-muted fw-bold">真實</small><div class="fw-bold fs-5 mt-1" id="bt-real">--</div></div></div>
                <div class="col-6"><div class="p-3 bg-light rounded" style="border:1px solid #818cf8;"><small class="text-primary fw-bold">預測</small><div class="fw-bold fs-5 mt-1 text-primary" id="bt-pred">--</div></div></div>
            </div>
            <div class="alert alert-light border mt-3 mb-0"><i class="fas fa-comment-dots text-secondary me-2"></i><span id="bt-comment" class="fw-bold text-dark">--</span></div>
            <div class="text-center mt-3"><button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="showLogicPopup()"><i class="fas fa-search me-1"></i> 還原演算細節</button></div>
        </div>
        <div class="kw-card p-0 overflow-hidden"><div id="chart-bt" style="height: 350px;"></div></div>
    </div>
</div>

<div class="modal fade" id="logicModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="fas fa-project-diagram me-2"></i>V9.9 核心演算解析報告</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-logic-content"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let latestResult = null;
let currentMarket = 'US';

// --- 工具：日期格式化 (含星期) ---
function formatFullDate(ts) {
    const d = new Date(ts);
    const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
    return `${d.getMonth()+1}/${d.getDate()} (${days[d.getDay()]})`;
}

// --- 數據讀取 (Multi-Proxy) ---
async function fetchStockData(symbol) {
    let querySymbol = symbol.toUpperCase().trim();
    let marketTag = 'US';
    if (/^\d{4,5}$/.test(querySymbol)) { querySymbol += ".HK"; marketTag = 'HK'; }
    else if (querySymbol.endsWith('.HK')) marketTag = 'HK';
    else if (querySymbol.endsWith('.TW')) marketTag = 'TW';
    
    currentMarket = marketTag;
    document.getElementById('market-tag').innerText = marketTag === 'HK' ? 'HKEX' : 'US MARKET';

    const proxies = [`https://api.allorigins.win/raw?url=`, `https://corsproxy.io/?`];
    for (let proxy of proxies) {
        try {
            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${querySymbol}?range=2y&interval=1d`;
            const resp = await fetch(proxy + encodeURIComponent(url));
            if(!resp.ok) continue;
            const json = await resp.json();
            const res = json.chart.result[0];
            const timestamps = res.timestamp;
            const quotes = res.indicators.quote[0];
            let formatted = [];
            if(timestamps) {
                for(let i=0; i<timestamps.length; i++) {
                    if(quotes.open[i]!=null && quotes.close[i]!=null) {
                        formatted.push({
                            t: timestamps[i]*1000,
                            o: quotes.open[i], h: quotes.high[i], l: quotes.low[i], c: quotes.close[i], v: quotes.volume[i]||0
                        });
                    }
                }
            }
            // Yahoo is old->new, we want new->old
            return formatted.reverse();
        } catch(e) {}
    }
    throw new Error("數據連接失敗，請稍後再試");
}

// --- V9.9 預測引擎 (Timezone & State Aware) ---
function runPredictionModel(allData, tIdx) {
    // [邏輯修正]
    // 我們要預測的是 allData[tIdx] 這一天。
    // 但是，輸入數據必須 "嚴格" 來自 allData[tIdx+1] ... allData[tIdx+5]。
    // 即使 allData[tIdx] 是即時盤中數據，我們也不能用它來預測它自己。
    
    const baseIdx = tIdx + 1; // 輸入數據從 "前一天" 開始
    if (baseIdx + 60 >= allData.length) return null;

    const history5 = allData.slice(baseIdx, baseIdx + 5);
    const avgVol = history5.reduce((acc, d) => acc + (d.h - d.l), 0) / 5;
    const refClose = allData[baseIdx].c;
    
    // 技術指標 (使用已收盤數據)
    const sma50 = allData.slice(baseIdx, baseIdx + 50).reduce((a,b)=>a+b.c,0)/50;
    let gains=0, losses=0;
    for(let i=baseIdx; i<baseIdx+14; i++){
        let d = allData[i].c - allData[i+1].c;
        if(d>=0) gains+=d; else losses-=d;
    }
    const rsi = 100 - (100/(1+(gains/14)/(losses/14)||1));

    let bias = 0, details = [];
    if(rsi > 70) { bias -= 0.15; details.push({t:"RSI 過熱 (>70)", type:"neg", desc:"市場情緒過度亢奮，回調風險大增"}); }
    else if(rsi < 30) { bias += 0.15; details.push({t:"RSI 超賣 (<30)", type:"pos", desc:"恐慌性拋售已現，技術反彈在即"}); }
    else details.push({t:`RSI 中性 (${rsi.toFixed(1)})`, type:"neu", desc:"多空力量相對均衡"});

    if(refClose > sma50) { bias += 0.05; details.push({t:"價格 > 50MA", type:"pos", desc:"股價位於生命線之上，多頭結構完整"}); }
    else { bias -= 0.05; details.push({t:"價格 < 50MA", type:"neg", desc:"股價受制於生命線，空頭壓力沈重"}); }

    const inertia = 0.65;
    let predH = refClose + (avgVol * inertia) + (avgVol * bias);
    let predL = refClose - (avgVol * inertia) + (avgVol * bias);
    
    const maxVol = Math.max(...history5.map(d=>d.h-d.l));
    let msg = null;
    if((predH-predL) > maxVol * 1.2) {
        const mid = (predH+predL)/2;
        const limit = (maxVol * 1.2)/2;
        predH = mid + limit; predL = mid - limit;
        msg = "預測波幅超出歷史極值，已啟動風控壓縮。";
    }

    return {
        predH, predL, refClose, avgVol, rsi, bias, details, msg,
        dir: ((predH+predL)/2 > refClose) ? 'UP' : 'DOWN',
        targetData: allData[tIdx], // 可能是今天(盤中)或明天(盤前)
        dateStr: formatFullDate(allData[tIdx].t),
        history: history5 // 用於解說
    };
}

async function runAnalysis(isBT) {
    const sym = document.getElementById('symbol').value;
    const dateInput = document.getElementById('test-date').value;
    const loading = document.getElementById('loading');
    
    document.getElementById('panel-live').style.display = 'none';
    document.getElementById('panel-backtest').style.display = 'none';
    loading.style.display = 'block';

    try {
        const allData = await fetchStockData(sym);
        
        if(!isBT) {
            // [時區判定邏輯 V9.9]
            // 判斷 Yahoo 回傳的最新一筆數據 (allData[0]) 日期
            const lastDate = new Date(allData[0].t);
            const now = new Date();
            
            // 簡單判斷：如果最新數據的日期跟今天日期一樣 (考慮時區大致相同)，代表盤中。
            // 我們預測這一天 (allData[0])，使用 allData[1..5]。
            // 如果最新數據是昨天，代表盤前。我們預測「未知的一天」。
            // 在此架構下，runPredictionModel(allData, 0) 是最穩健的寫法。
            // 它會嘗試預測 allData[0] (無論它是今天Live還是昨天Close) 的走勢。
            // *但在顯示上，如果 allData[0] 是昨天，我們要標示為 Next Day Forecast。*
            
            const r = runPredictionModel(allData, 0);
            latestResult = r;
            renderLive(allData, r);
        } else {
            if(!dateInput) throw new Error("請選擇日期");
            const tTs = new Date(dateInput).setHours(0,0,0,0);
            const idx = allData.findIndex(d => Math.abs(new Date(d.t).setHours(0,0,0,0) - tTs) < 86400000);
            if(idx === -1) throw new Error("無該日數據");
            const r = runPredictionModel(allData, idx);
            latestResult = r;
            renderBacktest(allData, r, idx);
        }
    } catch(e) { alert(e.message); } 
    finally { loading.style.display = 'none'; }
}

function renderLive(allData, r) {
    document.getElementById('panel-live').style.display = 'block';
    
    // 檢查目標日期是否為「今天」
    const tDate = new Date(r.targetData.t);
    const today = new Date();
    const isToday = tDate.getDate() === today.getDate();
    
    document.getElementById('res-date').innerText = isToday ? "LIVE TARGET (Real-time)" : "NEXT SESSION TARGET";
    document.getElementById('res-date').className = isToday ? "badge bg-danger ms-2 small" : "badge bg-primary ms-2 small";

    document.getElementById('pred-high').innerText = r.predH.toFixed(2);
    document.getElementById('pred-low').innerText = r.predL.toFixed(2);
    document.getElementById('pred-vol').innerText = `預期波幅: ${(r.predH-r.predL).toFixed(2)}`;
    
    const badge = document.getElementById('direction-badge');
    badge.className = r.dir === 'UP' ? 'trend-badge trend-up' : 'trend-badge trend-down';
    badge.innerHTML = r.dir === 'UP' ? '<i class="fas fa-arrow-trend-up me-2"></i>看漲 (Bullish)' : '<i class="fas fa-arrow-trend-down me-2"></i>看跌 (Bearish)';

    const tbody = document.getElementById('history-body'); tbody.innerHTML = '';
    for(let i=0; i<5; i++) {
        const pastR = runPredictionModel(allData, i);
        const real = allData[i];
        const acc = (pastR.predH >= real.h && pastR.predL <= real.l) ? 100 : 
                    Math.max(0, 100 - (Math.abs(real.h-pastR.predH) + Math.abs(real.l-pastR.predL))/real.c * 1000); // 簡易算法
        
        tbody.innerHTML += `<tr><td>${formatFullDate(real.t)}</td><td>${real.l.toFixed(2)} - ${real.h.toFixed(2)}</td><td>${pastR.predL.toFixed(2)} - ${pastR.predH.toFixed(2)}</td><td><span class="badge ${acc>70?'bg-success':'bg-secondary'}">${acc.toFixed(0)}%</span></td></tr>`;
    }
    
    // T+5 (保留 V9.3)
    const s = 50 + (r.dir==='UP'?20:-10) + (r.bias*100);
    const bar = (l,v) => `<div class="mb-3"><div class="d-flex justify-content-between small fw-bold"><span>${l}</span><span>${v.toFixed(0)}%</span></div><div class="prob-bar-bg"><div class="prob-bar-fill" style="width:${v}%"></div></div></div>`;
    document.getElementById('probs-container').innerHTML = bar('Target +1%', Math.min(95,s)) + bar('Target +3%', Math.min(95,s*0.8)) + bar('Target +5%', Math.min(95,s*0.6));

    drawChart('chart-live', allData, r);
}

function renderBacktest(allData, r, idx) {
    document.getElementById('panel-backtest').style.display = 'block';
    document.getElementById('bt-date-display').innerText = r.dateStr;
    document.getElementById('bt-real').innerText = `${r.targetData.l.toFixed(2)} - ${r.targetData.h.toFixed(2)}`;
    document.getElementById('bt-pred').innerText = `${r.predL.toFixed(2)} - ${r.predH.toFixed(2)}`;
    
    // 計算重疊度
    const oH = Math.min(r.predH, r.targetData.h); const oL = Math.max(r.predL, r.targetData.l);
    const acc = oH<=oL ? 0 : ((oH-oL)/(Math.max(r.predH,r.targetData.h)-Math.min(r.predL,r.targetData.l)))*100;
    
    document.getElementById('bt-score').innerText = acc.toFixed(1) + "%";
    document.getElementById('bt-comment').innerText = acc > 70 ? "AI 評語：精準。市場未受外力干擾，完全符合慣性。" : "AI 評語：偏差。市場受消息面影響脫離技術慣性。";
    drawChart('chart-bt', allData.slice(idx), r, true);
}

function showLogicPopup() {
    if(!latestResult) return;
    const r = latestResult;
    
    // V9.9 Point Form Content
    const inputDates = r.history.slice(0,3).map(d => formatFullDate(d.t)).join(', ');
    
    const biasList = r.details.map(d => 
        `<li><strong>${d.t}</strong>: ${d.desc} <span class="badge ${d.type==='pos'?'bg-success text-white':(d.type==='neg'?'bg-danger text-white':'bg-secondary text-white')} ms-1">${d.type==='pos'?'+':(d.type==='neg'?'-':'=')}</span></li>`
    ).join('');

    const html = `
        <div class="step-block">
            <div class="step-icon">1</div>
            <h5 class="fw-bold text-dark">慣性採樣 (Strict Sampling)</h5>
            <div class="viz-container bg-light">
                <div class="small text-muted mb-1">DATA INPUT WINDOW</div>
                <div class="fw-bold text-primary">${inputDates} ... (共5日)</div>
                <div class="text-xs text-muted mt-1"><i class="fas fa-lock me-1"></i>已強制排除實時盤中數據</div>
            </div>
            <ul class="point-list">
                <li><strong>嚴格時序控制：</strong> 系統偵測到預測目標日為 <u>${r.dateStr}</u>，因此強制鎖定該日之前的 5 個完整交易日作為樣本。</li>
                <li><strong>能量計算：</strong> 計算出這 5 日的平均真實波幅 (ATR Concept) 為 <strong>$${r.avgVol.toFixed(2)}</strong>。這代表該標的在無突發消息下的自然呼吸深度。</li>
                <li><strong>基準錨點：</strong> 以 T-1 日收盤價 <strong>$${r.refClose.toFixed(2)}</strong> 作為本次預測的起跑線。</li>
            </ul>
        </div>

        <div class="step-block">
            <div class="step-icon">2</div>
            <h5 class="fw-bold text-dark">環境向量修正 (Contextual Bias)</h5>
            <ul class="point-list">
                ${biasList}
                <li><strong>綜合判斷：</strong> 彙整上述因子後，系統給出 <strong>${(r.bias*100).toFixed(1)}%</strong> 的總修正係數。正值代表多頭動能強，推升預測區間；負值則代表壓力重，壓低區間。</li>
            </ul>
            <div class="viz-container">
                <div class="d-flex justify-content-between px-5">
                    <span class="text-danger fw-bold">空方 Bearish</span>
                    <div style="width: 2px; height: 20px; background: #cbd5e1;"></div>
                    <span class="text-success fw-bold">多方 Bullish</span>
                </div>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-primary" style="width: ${50 + (r.bias*100)}%"></div>
                </div>
            </div>
        </div>

        <div class="step-block">
            <div class="step-icon">3</div>
            <h5 class="fw-bold text-dark">最終區間生成 (Generation)</h5>
            <div class="formula-display">
                Target = Ref ± [ (AvgVol × 0.65) + Bias ]
                <br>
                High: $${r.predH.toFixed(2)}
                <br>
                Low : $${r.predL.toFixed(2)}
            </div>
            <ul class="point-list">
                <li><strong>慣性衰減 (0.65)：</strong> 根據物理慣性定律，波動能量會隨時間衰減。我們假設明日的自然波動僅繼承前五日平均能量的 65%。</li>
                <li><strong>區間成型：</strong> 將衰減後的能量加上環境修正值，疊加在基準價上，形成最終的預測信封 (Envelope)。</li>
                ${r.msg ? `<li class="text-danger fw-bold">⚠️ 風控介入：${r.msg}</li>` : ''}
            </ul>
        </div>
    `;
    
    document.getElementById('modal-logic-content').innerHTML = html;
    new bootstrap.Modal(document.getElementById('logicModal')).show();
}

function drawChart(id, data, r, showReal=false) {
    const container = document.getElementById(id); container.innerHTML = '';
    const chart = LightweightCharts.createChart(container, {
        layout: { textColor: '#333', background: { type: 'solid', color: 'white' } },
        width: container.clientWidth, height: 350
    });
    const candles = chart.addCandlestickSeries({ upColor: '#10b981', downColor: '#ef4444' });
    candles.setData(data.slice(0, 100).reverse().map(d => ({ time: d.t/1000, open: d.o, high: d.h, low: d.l, close: d.c })));
    
    const targetTime = r.targetData.t/1000;
    const lH = chart.addLineSeries({ color: '#4F46E5', lineWidth: 2, lineStyle: 2, title: 'AI High' });
    lH.setData([{ time: targetTime - 86400*5, value: r.predH }, { time: targetTime, value: r.predH }]);
    const lL = chart.addLineSeries({ color: '#4F46E5', lineWidth: 2, lineStyle: 2, title: 'AI Low' });
    lL.setData([{ time: targetTime - 86400*5, value: r.predL }, { time: targetTime, value: r.predL }]);
    chart.timeScale().fitContent();
}

document.getElementById('symbol').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') runAnalysis(false);
});
</script>
</body>
</html>
